<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2023 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2023 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">serial</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">regex</span> <span class="k">as</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">isclose</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">platform_setup_new</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="k">def</span> <span class="nf">log_action</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%y %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;device_log.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">gsioc_Protocol</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class implementing various common functions shared across GSIOC devices. This class implements:</span>
<span class="sd">    - verify_open : Checks if the port is open; If not opens it</span>
<span class="sd">    - verify_device : Checks that the device is correct</span>
<span class="sd">    - connect : Connects to device specified through ID, verifies device is correct</span>
<span class="sd">    - iCommand : Immediate Command</span>
<span class="sd">    - bCommand : Buffered Command</span>

<span class="sd">    A seperate class passes a serial port object to this class to allow connecting multiple GSIOC devices through</span>
<span class="sd">    a single serial port. The devices are identified through their ID.              </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">logging</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">serial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_name</span> <span class="o">=</span> <span class="n">device_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logging_enabled</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># ✅ Start with logging ON</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_logger</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># ✅ Prevent duplicate handlers</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;autosampler_log.txt&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;[{time:DD/MM/YY HH:mm:ss}] - </span><span class="si">{level}</span><span class="s2"> - </span><span class="si">{message}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># ✅ Logging is OFF by default</span>

    <span class="k">def</span> <span class="nf">enable_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># ✅ Turn logging ON</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Logging enabled.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disable_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># ✅ Turn logging OFF</span>

    <span class="k">def</span> <span class="nf">log_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper to log messages only when enabled&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_enabled</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># Checks if SerialPort is open; If not opens it</span>
    <span class="k">def</span> <span class="nf">verify_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Check if port is open.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">isOpen</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Port is not opening.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>
 
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Check that we are connected to the right device</span>
    <span class="k">def</span> <span class="nf">verify_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Verify that it is connected to the correct device (device_name)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">device_version_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">device_string</span> <span class="o">=</span> <span class="n">device_version_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; v&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Return True if correct device, False otherwise</span>
        <span class="k">return</span> <span class="n">device_string</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_name</span>

    <span class="c1"># Connect to Device using UnitID (see manual + back of device)</span>
    <span class="c1"># Verify that it&#39;s the right device</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Verify port is opened</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_open</span><span class="p">()</span>

        <span class="c1"># Connect to unit ID</span>
        <span class="k">if</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ID out of range [0,63]&quot;</span><span class="p">)</span>

        <span class="n">byte_ID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">+</span>  <span class="mi">128</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s1">&#39;ff&#39;</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>   <span class="c1"># Passively wait for all devices to disconnect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">byte_ID</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">))</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>    <span class="c1"># Will return empty array after timeout</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resp</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;No response from device&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempt </span><span class="si">{</span><span class="mi">100</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span><span class="si">}</span><span class="s1">/100: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="si">}</span><span class="s1"> No response from device </span><span class="si">{</span><span class="n">byte_ID</span><span class="o">-</span><span class="mi">128</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">log_action</span><span class="p">(</span><span class="s1">&#39;test_log.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;Unable to connect to Gilson autosampler.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;No response from device&quot;</span><span class="p">)</span>

        <span class="c1"># Verifies that the correct device is connected</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify_device</span><span class="p">():</span>
            
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to device </span><span class="si">{</span><span class="n">byte_ID</span><span class="o">-</span><span class="mi">128</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">log_action</span><span class="p">(</span><span class="s1">&#39;test_log.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;Connected to autosampler.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connected to autosampler&quot;</span><span class="p">)</span>
            
        <span class="c1"># Wrong Device ID</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connected to wrong device: connecting to device </span><span class="si">{</span><span class="n">byte_ID</span><span class="o">-</span><span class="mi">128</span><span class="si">}</span><span class="s1"> failed.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempt </span><span class="si">{</span><span class="mi">100</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span><span class="si">}</span><span class="s1">/100: Tried connecting to device: </span><span class="si">{</span><span class="n">byte_ID</span><span class="o">-</span><span class="mi">128</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Connected to wrong device: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Connected to wrong device: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)))</span>

    <span class="c1"># Send immediate Command; One Character at most</span>
    <span class="k">def</span> <span class="nf">iCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandstring</span><span class="p">):</span>
        
        <span class="c1"># Convert to binary</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_qp</span><span class="p">(</span><span class="n">commandstring</span><span class="p">)</span>

        <span class="c1"># Write command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

        <span class="c1"># Retrieve Response - looks like this returns one byte at a time...</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">resp_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>    <span class="c1"># Will return empty array after timeout</span>

            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resp_raw</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempt </span><span class="si">{</span><span class="mi">100</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span><span class="si">}</span><span class="s1">/100: sent Immediate Command </span><span class="si">{</span><span class="n">commandstring</span><span class="si">}</span><span class="s1">, in binascii: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="n">commandstring</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;No response from device&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;No response from device&quot;</span><span class="p">)</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Extended ASCII represents end of message</span>
            <span class="k">if</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">):</span>
                <span class="n">resp</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">128</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending immediate command complete.&#39;</span><span class="p">)</span>
                
                <span class="k">break</span>

            <span class="c1"># Write Acknowledge to Device to signal next byte can be retrieved</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;06&quot;</span><span class="p">))</span>
                
        <span class="c1"># logger.debug(&#39;Received {} as response&#39;.format(resp.decode(&quot;ascii&quot;)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;received </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s1"> as response.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>

    <span class="c1"># Buffered Command; More then one character</span>
    <span class="k">def</span> <span class="nf">bCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commandstring</span><span class="p">):</span>

        <span class="c1"># Convert to byte, \n signifies start of command, \r signals end of command</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_qp</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">commandstring</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;GSIOC &lt;&lt;&lt; </span><span class="si">{</span><span class="n">commandstring</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># begin buffered command by sending \n until the device echos \n or times out</span>
        <span class="n">firstErrorPrinted</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># This is used to prevent repetitive printing</span>

        <span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>    <span class="c1"># send \n</span>
            <span class="n">resp_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>    <span class="c1"># Will return empty array after timeout J.F.W.&gt;&gt;&gt; changed to 2 bytes. If no timeout is defined in serial, it will simply wait forever!</span>
            
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resp_raw</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempt </span><span class="si">{</span><span class="mi">100</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span><span class="si">}</span><span class="s1">/100: sent buffered Command </span><span class="si">{</span><span class="n">commandstring</span><span class="si">}</span><span class="s1">, in binascii: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="n">commandstring</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;No response from device&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;No response from device&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ready signal: </span><span class="si">{</span><span class="n">resp_raw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1">################################################################################################################</span>
            <span class="c1"># TODO CHECK IF THE FOLLOWING CONIDTION RAISES MORE PROBLEMS!!! IT IS MEANT TO FIX THE INDEX OUT OF RANGE ERROR!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resp_raw</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1">################################################################################################################</span>
            <span class="n">readySig</span> <span class="o">=</span> <span class="n">resp_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># If devices answers \n signifies device is ready</span>
            <span class="k">if</span><span class="p">(</span><span class="n">readySig</span> <span class="o">==</span> <span class="mi">10</span><span class="p">):</span> <span class="c1">#J.F.W.&gt;&gt;&gt; 10 is ascii code for Line Feed LF</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting to send buffered command.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># Device is busy</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">readySig</span> <span class="o">==</span> <span class="mi">35</span><span class="p">):</span> <span class="c1">#J.F.W&gt;&gt;&gt; 35 is ascii code for &quot;#&quot;-symbol</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">firstErrorPrinted</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Device busy. Waiting....&#39;</span><span class="p">)</span>
                    <span class="n">firstErrorPrinted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Did not recieve </span><span class="se">\\</span><span class="s2">n (0x0A) or # as response&quot;</span><span class="p">)</span>
                <span class="c1"># raise Exception(&quot;Did not recieve \\n (0x0A) or # as response&quot;)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">readySig</span><span class="p">)</span><span class="c1">#.decode(&quot;ascii&quot;)) #JFW&gt;&gt;&gt;</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">readySig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
        <span class="c1"># Send buffered data, one byte at a time, Device echo&#39;s byte send</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writes buffered Command character </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> to the device </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device_name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starts reading character from the device </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device_name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="n">resp_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>    <span class="c1"># Will return empty array after timeout</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;got back </span><span class="si">{</span><span class="n">resp_raw</span><span class="si">}</span><span class="s1"> from the device </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device_name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="c1"># for i in range(len(data)):</span>
        <span class="c1">#     self.serial.write(data[i:i+1])</span>
        <span class="c1">#     resp_raw = self.serial.read(3) </span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;resp_raw: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">))</span> <span class="c1">#JFW&gt;&gt;&gt;</span>

            <span class="c1"># self.serial.flushInput()</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resp_raw</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempt </span><span class="si">{</span><span class="mi">100</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span><span class="si">}</span><span class="s1">/100: sent buffered Command </span><span class="si">{</span><span class="n">commandstring</span><span class="si">}</span><span class="s1">, in binascii: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="n">commandstring</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;No response from device&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;No response from device&quot;</span><span class="p">)</span>
                <span class="c1"># logger.debug(resp_raw) #JFW&gt;&gt;&gt;</span>

            <span class="c1"># logger.debug(&quot;resp_raw: &quot;+str(resp_raw))</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resp_raw 2: </span><span class="si">{</span><span class="n">resp_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># resp=binascii.a2b_qp(resp)</span>
            <span class="c1"># if(resp[len(resp)-1] &gt; 127):</span>
            <span class="c1">#     resp[len(resp)-1] -= 128</span>
           

            <span class="k">if</span><span class="p">(</span> <span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="p">[:]))</span> <span class="c1">#JFW&gt;&gt;&gt;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Data:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[:]))</span> <span class="c1">#JFW&gt;&gt;&gt;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Received &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; instead of &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                <span class="c1"># raise Exception(&quot;Received &quot; + str(resp) + &quot; instead of &quot; + str(data[i:i+1]))</span>
            
            <span class="k">if</span><span class="p">(</span> <span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">13</span> <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Buffered command complete.&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s1"> from device.&#39;</span><span class="p">)</span>    
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;GSIOC &gt;&gt;&gt; </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">resp</span>
            
            <span class="k">if</span> <span class="n">commandstring</span> <span class="o">==</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
                <span class="n">log_action</span><span class="p">(</span><span class="s1">&#39;test_log.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;Autosampler sent to home position.&quot;</span><span class="p">)</span>           

            <span class="k">elif</span> <span class="n">commandstring</span> <span class="o">==</span> <span class="s1">&#39;e[n]&#39;</span><span class="p">:</span>
                <span class="n">log_action</span><span class="p">(</span><span class="s1">&#39;test_log.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;Autosampler has cleared errors.&quot;</span><span class="p">)</span>  

        <span class="c1"># This will happen if sending the data failed</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Buffered command FAILED&quot;</span><span class="p">)</span>
        <span class="n">resp_no_whitespace</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">resp_no_whitespace</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>

    

        
            

    <span class="c1">## General Commands ##</span>
    <span class="k">def</span> <span class="nf">closeSerial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
         
    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_device_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">go_to_vial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vial</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="s1">&#39;Z125&#39;</span><span class="p">)</span>
        <span class="n">thing</span> <span class="o">=</span> <span class="n">rack1_commands</span><span class="o">.</span><span class="n">get_xy_command</span><span class="p">(</span><span class="n">vial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="n">thing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">log_action</span><span class="p">(</span><span class="s1">&#39;test_log.txt&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Autosampler sent to </span><span class="si">{</span><span class="n">vial</span><span class="si">}</span><span class="s2"> position.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">go_to_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="s1">&#39;Z125&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="s1">&#39;X146.5/0&#39;</span><span class="p">)</span>
        <span class="c1">#self.bCommand(&#39;Z105&#39;) #test if this works</span>

    <span class="k">def</span> <span class="nf">go_to_home</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="s1">&#39;Z125&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
        <span class="n">log_action</span><span class="p">(</span><span class="s1">&#39;test_log.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;Autosampler sent to home position.&#39;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">rack1</span><span class="p">:</span>
    <span class="n">rack_position_offset_x</span><span class="o">=</span><span class="mi">92</span>       <span class="c1">#distance in mm between rack_position=1 and =2 on x-axis</span>
    <span class="n">rack_position_offset_y</span><span class="o">=</span><span class="mi">0</span>        <span class="c1">#distance in mm between rack_position=1 and =2 on y-axis</span>
    
    <span class="c1">############################# RACK 1 DEFINITION #################################</span>
    
    <span class="c1"># From platform_setup.py </span>
    <span class="n">rack1</span> <span class="o">=</span> <span class="n">Rack</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">16</span><span class="p">],</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">39.5</span><span class="p">,</span> <span class="mf">18.5</span><span class="p">,</span> <span class="mf">13.75</span><span class="p">,</span> <span class="mi">65</span><span class="p">)</span> <span class="c1"># groundlevel_height assumed the minimum Z</span>
    
    <span class="c1">#  array_dimensions, offset_x, offset_y=offset_y, vial2vial_x, vial2vial_y, groundlevel_height</span>
    
    <span class="c1"># Previous vial2vialx = (2.11+15.6)</span>
    <span class="c1"># Previous vial2vial7 = (2.72+15.6+0.35)</span>
    
    <span class="n">array_order1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>      <span class="c1">#user is obliged to define a integer number i&gt;=1 for each vial in the rack in ascending order </span>
        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span>     
        <span class="p">[</span><span class="mi">25</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">28</span><span class="p">],</span>     
        <span class="p">[</span><span class="mi">29</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">32</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">33</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">36</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">37</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">40</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">41</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">44</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">45</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">48</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">49</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">52</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">53</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">56</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">57</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">60</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">61</span><span class="p">,</span><span class="mi">62</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">64</span><span class="p">]</span>        
        <span class="p">])</span>
        
    <span class="n">rack_pos1</span><span class="o">=</span><span class="mi">1</span>
    
    <span class="k">global</span> <span class="n">rack1_commands</span>
    
    <span class="c1"># Not sure what rack_position_offset_x/y are for x=92 and y=0</span>
    
    <span class="n">rack1_commands</span> <span class="o">=</span> <span class="n">Rackcommands</span><span class="p">(</span><span class="n">rack1</span><span class="p">,</span> <span class="n">array_order1</span><span class="p">,</span> <span class="n">rack_pos1</span><span class="p">,</span> <span class="n">rack_position_offset_x</span><span class="p">,</span> <span class="n">rack_position_offset_y</span><span class="p">)</span>
    
    <span class="k">global</span> <span class="n">vial_selfmade</span>
    
    <span class="n">vial_selfmade</span> <span class="o">=</span> <span class="n">Vial</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mf">31.08</span><span class="p">)</span>






<span class="k">class</span> <span class="nc">DeviceController</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serial_connection</span><span class="p">,</span> <span class="n">max_repeats</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">serial_connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_repeats</span> <span class="o">=</span> <span class="n">max_repeats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">=</span> <span class="n">max_repeats</span>

    <span class="c1"># 3. Method Definition</span>
    <span class="k">def</span> <span class="nf">iCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commandstring</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sending immediate command </span><span class="si">{</span><span class="n">commandstring</span><span class="si">}</span><span class="s1"> to device.&#39;</span><span class="p">)</span>
        
        <span class="c1"># Convert to binary</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_qp</span><span class="p">(</span><span class="n">commandstring</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Converted command to binary: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Write command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Command written to serial port.&#39;</span><span class="p">)</span>

        <span class="c1"># Retrieve Response</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">resp_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>    <span class="c1"># Will return empty array after timeout</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received raw response: </span><span class="si">{</span><span class="n">resp_raw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No response received. Connection repeats left: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Attempt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_repeats</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">connection_repeats</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_repeats</span><span class="si">}</span><span class="s1">: sent Immediate Command </span><span class="si">{</span><span class="n">commandstring</span><span class="si">}</span><span class="s1">, in binascii: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="n">commandstring</span><span class="p">)</span>  <span class="c1"># Safe recursion</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;No response from device after maximum retries.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot; No response from device&quot;</span><span class="p">)</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">resp_raw</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current response buffer: </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Extended ASCII represents end of message</span>
            <span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
                <span class="n">resp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">128</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;End of message detected, adjusted last byte: </span><span class="si">{</span><span class="n">resp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sending immediate command complete.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># Write Acknowledge to Device to signal next byte can be retrieved</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">flushInput</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;06&quot;</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Acknowledgement sent to device.&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Received full response: </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_xy_position_change</span><span class="p">(</span><span class="n">gsioc_lh</span><span class="p">,</span> <span class="n">logging_entity</span><span class="p">,</span> <span class="n">destination_command</span><span class="p">,</span> <span class="n">TESTING_ACTIVE</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if current x/y-position is close to the expected destination. </span>
<span class="sd">    Returns True if position is the expected one, False if not.&quot;&quot;&quot;</span>
    
    <span class="n">logging_entity</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The following command is checked: </span><span class="si">{</span><span class="n">destination_command</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span>  <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;^X(\d+\.?(\d+)?)/(\d+\.?(\d+)?)$&#39;</span><span class="p">,</span><span class="n">destination_command</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">gsioc_lh</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">current_xy_position</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gsioc_lh</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">))</span>
        <span class="c1"># Reformat destination and current position (expected gsioc command &quot;X###.######/###.######&quot;)</span>
        <span class="n">dest_posx</span><span class="p">,</span> <span class="n">dest_posy</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">destination_command</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">current_posx</span><span class="p">,</span> <span class="n">current_posy</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_xy_position</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">TESTING_ACTIVE</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">current_posx</span> <span class="o">=</span> <span class="n">dest_posx</span>
            <span class="n">current_posy</span> <span class="o">=</span> <span class="n">dest_posy</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">dest_posx</span><span class="p">,</span><span class="n">dest_posy</span><span class="p">,</span><span class="n">current_posx</span><span class="p">,</span><span class="n">current_posy</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)):</span>
            <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">cond_x</span> <span class="o">=</span> <span class="n">isclose</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">abs_tol</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">cond_y</span> <span class="o">=</span> <span class="n">isclose</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">coords</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">abs_tol</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cond_x</span> <span class="ow">and</span> <span class="n">cond_y</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging_entity</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X/Y-POSITION </span><span class="si">{</span><span class="n">current_xy_position</span><span class="si">}</span><span class="s1"> UNEXPECTED. Expected: </span><span class="si">{</span><span class="n">destination_command</span><span class="si">}</span><span class="s1">, equality up to a difference of 0.6 mm.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging_entity</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;INVALID USE OF FUNCTION. Expected X/Y-command, not </span><span class="si">{</span><span class="n">destination_command</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">ensure_xy_position_will_be_reached</span><span class="p">(</span><span class="n">gsioc_liqhan</span><span class="p">,</span><span class="n">attempts</span><span class="p">,</span><span class="n">logging_entity</span><span class="p">,</span><span class="n">xy_positioning_command</span><span class="p">,</span> <span class="n">TESTING_ACTIVE</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">logging_entity</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The following command is ensured to get reached: </span><span class="si">{</span><span class="n">xy_positioning_command</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">gsioc_liqhan</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="c1"># gsioc_liqhan.bCommand(&#39;H&#39;)</span>
    <span class="n">gsioc_liqhan</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="s1">&#39;Z125&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">attempts</span><span class="p">):</span>
        <span class="n">gsioc_liqhan</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="n">xy_positioning_command</span><span class="p">)</span>
        <span class="n">approval</span> <span class="o">=</span> <span class="n">check_xy_position_change</span><span class="p">(</span><span class="n">gsioc_liqhan</span><span class="p">,</span><span class="n">logging_entity</span><span class="p">,</span><span class="n">xy_positioning_command</span><span class="p">,</span> <span class="n">TESTING_ACTIVE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging_entity</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X/Y-POSITION UNEXPECTED&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">attempts</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;This Error was raised after </span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s1"> attemps of repositioning to </span><span class="si">{</span><span class="n">xy_positioning_command</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">approval</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">PORT1</span>   <span class="o">=</span> <span class="s1">&#39;COM1&#39;</span>
    <span class="n">ser</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span><span class="n">PORT1</span><span class="p">,</span><span class="mi">19200</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s2">&quot;N&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span> 
    <span class="n">g</span> <span class="o">=</span> <span class="n">gsioc_Protocol</span><span class="p">(</span><span class="n">ser</span><span class="p">,</span><span class="s1">&#39;GX-241 II&#39;</span><span class="p">,</span><span class="mi">33</span><span class="p">)</span>
    <span class="c1">#g1 = gsioc_Protocol(ser,&#39;GX D Inject&#39;,3)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="c1">###### COMMANDS TO THE LIQUID HANDLER ######</span>
    <span class="n">g</span><span class="o">.</span><span class="n">iCommand</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">bCommand</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1">#g1.connect()</span>
    <span class="c1">##### COMMANDS TO THE VALVE ######</span>
    <span class="c1">#g1.iCommand(&quot;%&quot;)</span>
    <span class="c1">#g1.bCommand(&#39;VL&#39;)</span>

<span class="k">class</span> <span class="nc">Rack</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation for a Rack within the flow setup.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array_dimensions</span><span class="p">,</span> <span class="n">offset_x</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">vial2vial_x</span><span class="p">,</span> <span class="n">vial2vial_y</span><span class="p">,</span> <span class="n">groundlevel_height</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array_dimensions</span><span class="o">=</span><span class="n">array_dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_x</span><span class="o">=</span><span class="n">offset_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_y</span><span class="o">=</span><span class="n">offset_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vial2vial_x</span><span class="o">=</span><span class="n">vial2vial_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vial2vial_y</span><span class="o">=</span><span class="n">vial2vial_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groundlevel_height</span><span class="o">=</span><span class="n">groundlevel_height</span>    
    
    <span class="k">def</span> <span class="nf">get_vial_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vial_position</span><span class="p">,</span> <span class="n">array_order</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get indices of a specific vial in a rack with a certain order of the vials</span>
<span class="sd">        :returns: a tuple of (i,j) with i=vial-position along x-axis, and j=vial-position along y-axis</span>
<span class="sd">        TODO: verify that input is valid type, array dimensions and validation of the inputted values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">array_order</span><span class="o">==</span><span class="n">vial_position</span><span class="p">)</span>
        <span class="c1"># print(str(f&#39;indices are: {indices}&#39;))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            
            <span class="k">return</span> <span class="n">indices</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">tolerance</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;no&#39;</span><span class="p">:</span>                <span class="c1">#tolerance settings</span>
            <span class="c1">#REMOVE THIS STATEMENT!!!</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fatal error: zero vials with position number </span><span class="si">{</span><span class="n">vial_position</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>                        <span class="c1">#REMOVE THIS STATEMENT!!!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;warning: multiple vials with position number </span><span class="si">{</span><span class="n">vial_position</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">indices</span>


<span class="k">class</span> <span class="nc">Rackcommands</span><span class="p">():</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation for Commands connected to the Rack of the flow setup.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rack</span><span class="p">,</span><span class="n">rack_order</span><span class="p">,</span><span class="n">rack_position</span><span class="p">,</span><span class="n">rack_position_offset_x</span><span class="p">,</span><span class="n">rack_position_offset_y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rack</span><span class="o">=</span><span class="n">rack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rack_order</span><span class="o">=</span><span class="n">rack_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rack_position</span><span class="o">=</span><span class="n">rack_position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rack_position_offset_x</span><span class="o">=</span><span class="n">rack_position_offset_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rack_position_offset_y</span><span class="o">=</span><span class="n">rack_position_offset_y</span>
        
    <span class="k">def</span> <span class="nf">get_xy_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vial_pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="c1">#speed 125mm/s, force 100%</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;returns a str object command suitable for the liquid handler gx-241&quot;&quot;&quot;</span>
        
        <span class="n">index_y</span><span class="p">,</span> <span class="n">index_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rack</span><span class="o">.</span><span class="n">get_vial_indices</span><span class="p">(</span><span class="n">vial_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rack_order</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_x</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">index_y</span><span class="p">):</span>
            <span class="n">command</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index_x</span><span class="p">)):</span>
                <span class="n">i_x</span><span class="o">=</span><span class="n">index_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i_y</span><span class="o">=</span><span class="n">index_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">distance_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rack</span><span class="o">.</span><span class="n">offset_x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rack</span><span class="o">.</span><span class="n">vial2vial_x</span> <span class="o">*</span> <span class="n">i_x</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rack_position</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rack_position_offset_x</span>    
                <span class="n">distance_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rack</span><span class="o">.</span><span class="n">offset_y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rack</span><span class="o">.</span><span class="n">vial2vial_y</span> <span class="o">*</span> <span class="n">i_y</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rack_position</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rack_position_offset_y</span>    
                <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X</span><span class="si">{</span><span class="n">distance_x</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">distance_y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">command</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;error: len(index_x) != len(index_y) &quot;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">Vial</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation for a Vial within the flow setup.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vial_volume_max</span><span class="p">,</span><span class="n">vial_usedvolume_max</span><span class="p">,</span><span class="n">vial_height</span><span class="p">,</span><span class="n">vial_free_depth</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vial_volume_max</span><span class="o">=</span><span class="n">vial_volume_max</span>                <span class="c1">#volume in mL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vial_usedvolume_max</span><span class="o">=</span><span class="n">vial_usedvolume_max</span>        <span class="c1">#volume in mL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vial_height</span><span class="o">=</span><span class="n">vial_height</span>                        <span class="c1">#height in mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vial_free_depth</span><span class="o">=</span><span class="n">vial_free_depth</span>                <span class="c1">#depth in mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sum_liquid_level</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</body>
</html>
